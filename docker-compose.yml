version: '3.8'

services:
  opds:
    build: .
    container_name: calibre-opds-server
    ports:
      - "1580:5000"  # 外部端口1580映射到容器端口5000
    volumes:
      # 映射Calibre库目录到容器的 /books 目录
      # 请将此路径替换为您的实际Calibre库路径
      - /vol2/1000/Books:/books:ro  # 使用 :ro 表示只读权限
      # 日志文件持久化
      - ./logs:/app/logs
    environment:
      - FLASK_ENV=production  # 生产环境
      - PYTHONUNBUFFERED=1
      - CALIBRE_BOOKS_PATH=/books
      - CALIBRE_DB_PATH=/books/metadata.db
      # SQLite连接优化配置 - 移除连接池，采用SQLite最佳实践
      - DB_CONNECTION_TIMEOUT=60.0         # 增加连接超时时间（从30到60秒）
      
      # 日志配置 - 生产环境优化
      - LOG_LEVEL=INFO                     # 生产环境日志级别
      - LOG_FILE=/app/logs/calibre_opds.log
      - LOG_MAX_BYTES=10485760             # 10MB
      - LOG_BACKUP_COUNT=5
      - LOG_TO_CONSOLE=false               # 关闭控制台日志，减少IO（文石阅读器优化）
      # OPDS服务配置
      - OPDS_HOST=0.0.0.0
      - OPDS_PORT=5000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]  # 使用新的健康检查端点
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # 资源限制 - 防止资源耗尽影响文石阅读器
    deploy:
      resources:
        limits:
          cpus: '2.0'      # 限制CPU使用
          memory: 1G       # 限制内存使用
        reservations:
          cpus: '0.5'      # 保留最小CPU
          memory: 256M     # 保留最小内存
    networks:
      - opds-network

networks:
  opds-network:
    driver: bridge

# 使用说明：
# 1. 确保您有Calibre库目录（包含metadata.db文件）
# 2. 将 ./calibre-library 替换为您的实际库路径
# 3. 运行: docker-compose up -d
# 4. 访问: http://localhost:1580/opds
# 注意：外部端口是1580，不是5000